apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: main-ingress
  annotations:
    # 必要的 CORS 設定
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "PUT, GET, POST, OPTIONS"
    # nginx.ingress.kubernetes.io/cors-allow-origin: "http://localhost:5173"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
    # WebSocket 設定
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    # 強制 Nginx 使用 HTTP 1.1 (WebSocket 必須)
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    # 確保 Upgrade 標頭被正確傳遞給後端
    nginx.ingress.kubernetes.io/proxy-set-header-Upgrade: "$http_upgrade"
    nginx.ingress.kubernetes.io/proxy-set-header-Connection: "upgrade"
spec:
  ingressClassName: nginx
  rules:
    - http:
        paths:
          # 1. Auth Service
          # 只要網址是 /auth 開頭，就丟給 auth-service 的 8081 port
          - path: /auth
            pathType: Prefix
            backend:
              service:
                name: auth-service
                port:
                  number: 8081

          # 2. Chat Service (WebSocket)
          - path: /ws
            pathType: Prefix
            backend:
              service:
                name: chat-service
                port:
                  number: 8080

          # 3. Chat Service (API)
          - path: /api/rides
            pathType: Prefix
            backend:
              service:
                name: chat-service
                port:
                  number: 8080
          # frontend base path
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 5173
# 資源 (Resources) 走 /api/xxx：例如 rides, users, orders。這是 RESTful 的標準
# 功能 (Functions) 走特定路徑：例如 /auth (登入), /ws (連線)
